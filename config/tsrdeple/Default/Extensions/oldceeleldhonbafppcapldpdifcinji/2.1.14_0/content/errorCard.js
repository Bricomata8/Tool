/*! (C) Copyright 2018 LanguageTooler GmbH. All rights reserved. */
class ErrorCard{constructor(e,t,r){this.error=e,this._inputArea=r,this._domMeasurement=new DomMeasurement,this._eventListeners=[],this._render(t)}_getVisibleBox(e=!0){e&&this._domMeasurement.clearCache();const t=this._domMeasurement.getDocumentScroll(),r=document.documentElement.clientHeight,i=document.documentElement.clientWidth;return{top:t.top,left:t.left,bottom:t.top+r,right:t.left+i,height:r,width:i}}_render(e){this._container=document.createElement(ErrorCard.CONTAINER_ELEMENT_NAME),this._container.setAttribute("contenteditable","false"),this._eventListeners.push(addUseCaptureEvent(document,"keydown",this._onKeyDown.bind(this)),addUseCaptureEvent(this._container,"mousedown",e=>{e.stopImmediatePropagation(),e.preventDefault()}),addUseCaptureEvent(this._container,"mouseup",e=>e.stopImmediatePropagation()),addUseCaptureEvent(this._container,"pointerdown",e=>e.stopImmediatePropagation()),addUseCaptureEvent(this._container,"pointerup",e=>e.stopImmediatePropagation())),this._container.addEventListener("click",e=>e.stopPropagation());const t=document.createElement("lt-div");t.classList.add("lt-errorcard__container");const r=document.createElement("lt-div");if(r.classList.add("lt-errorcard__title"),r.textContent=this.error.description,t.appendChild(r),this.error.rule.urls&&this.error.rule.urls.length>0){const e=document.createElement("lt-span");e.classList.add("lt-errorcard__more-details"),e.title=browser.i18n.getMessage("moreDetails"),this._eventListeners.push(addUseCaptureEvent(e,"click",this._onMoreDetailsClick.bind(this))),r.appendChild(e)}const i=Math.min(this.error.fixes.length,config.MAX_FIXES_COUNT);for(let e=0;e<i;e++){const r=document.createElement("lt-span");r.classList.add("lt-errorcard__fix-title"),r.textContent=this.error.fixes[e].value,this.error.fixes[e].shortDescription&&(r.title=this.error.fixes[e].shortDescription),r.dataset.index=e.toString(),this._eventListeners.push(addUseCaptureEvent(r,"click",this._onFixClick.bind(this))),t.appendChild(r)}const o=document.createElement("lt-div");o.classList.add("lt-errorcard__validation-tweak-button"),this.error.isSpellingError?(o.classList.add("lt-errorcard__validation-tweak-button-add-to-dictionary"),o.textContent=browser.i18n.getMessage("addToDictionaryTitle",this.error.misspelledWord),this._eventListeners.push(addUseCaptureEvent(o,"click",this._onAddToDictionaryClick.bind(this)))):(o.classList.add("lt-errorcard__validation-tweak-button-turn-off-rule"),o.textContent=browser.i18n.getMessage("turnOffRule"),this._eventListeners.push(addUseCaptureEvent(o,"click",this._onTurnOffRuleClick.bind(this)))),t.appendChild(o);const s=document.createElement("lt-span");s.className="lt-errorcard__close-button",this._eventListeners.push(addUseCaptureEvent(s,"click",this._onCloseClicked.bind(this))),t.appendChild(s),this._container.appendChild(t),"BODY"===this._inputArea.tagName?document.documentElement.appendChild(this._container):document.body.appendChild(this._container),this._domMeasurement.clearCache();const n=this._getVisibleBox(),a=this._domMeasurement.getBorderBox(t),d=Math.min(e.left,n.width-a.width);let c=e.bottom+5;c+a.height>n.bottom&&(c=Math.max(n.top,e.top-a.height-5)),t.style.left=d+"px",t.style.top=c+"px",Tracker.trackEvent("Action","check_trigger:open")}_onMoreDetailsClick(e){e.stopImmediatePropagation();const t={errorCard:this,url:this.error.rule.urls[0].value};dispatchCustomEvent(ErrorCard.eventNames.moreDetailsClicked,t)}_onFixClick(e){e.stopImmediatePropagation();const t=+e.target.dataset.index,r={errorCard:this,error:this.error,fixIndex:t};dispatchCustomEvent(ErrorCard.eventNames.fixSelected,r)}_onAddToDictionaryClick(e){e.stopImmediatePropagation();const t={errorCard:this,error:this.error};dispatchCustomEvent(ErrorCard.eventNames.addToDictionaryClicked,t)}_onTurnOffRuleClick(e){e.stopImmediatePropagation();const t={errorCard:this,error:this.error};dispatchCustomEvent(ErrorCard.eventNames.turnOffRuleClicked,t)}_onCloseClicked(e){e.stopImmediatePropagation(),this.destroy()}_onKeyDown(e){"Escape"===e.key&&(this.destroy(),e.stopImmediatePropagation())}destroy(){if(this._container){this._container.remove(),this._container=null;const e={errorCard:this,error:this.error};dispatchCustomEvent(ErrorCard.eventNames.destroyed,e)}this._eventListeners.forEach(e=>{e.destroy()}),this._eventListeners=[]}}ErrorCard.CONTAINER_ELEMENT_NAME="lt-errorcard",ErrorCard.eventNames={moreDetailsClicked:"lt-errorCard.moreDetailsClicked",fixSelected:"lt-errorCard.fixSelected",addToDictionaryClicked:"lt-errorCard.addToDictionaryClicked",turnOffRuleClicked:"lt-errorCard.turnOffRuleClicked",destroyed:"lt-errorCard.destroyed"};