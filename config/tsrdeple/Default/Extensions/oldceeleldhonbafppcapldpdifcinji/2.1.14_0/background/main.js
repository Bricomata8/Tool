/*! (C) Copyright 2018 LanguageTooler GmbH. All rights reserved. */
const UNSUPPORTED_LANGUAGE_NAME="NoopLanguage";browser.runtime.onMessage.addListener(onMessage),browser.runtime.onInstalled.addListener(onInstalled);const storageController=new StorageController(onDataLoaded),extensionStates={},staticTextValidations={},validationsWithinOneSecond={count:0,tracked:!1};function updateBadge(e,t){browser.browserAction.setBadgeTextColor&&browser.browserAction.setBadgeTextColor({tabId:e,color:"#FFFFFF"}),t.enabled&&t.supported?t.capitalization?browser.browserAction.setBadgeText({tabId:e,text:""}):(browser.browserAction.setBadgeBackgroundColor({tabId:e,color:"#45A8FC"}),browser.browserAction.setBadgeText({tabId:e,text:isOpera()?"":"abc"})):(browser.browserAction.setBadgeBackgroundColor({tabId:e,color:"#F53987"}),browser.browserAction.setBadgeText({tabId:e,text:isOpera()?"":"OFF"}))}function onMessage(e,t,a){switch(e.command){case"PAGE_LOADED":{if(0!==t.frameId||!t.tab)break;const a=t.tab.id,n={enabled:e.enabled,capitalization:e.capitalization,supported:e.supported,unsupportedMessage:e.unsupportedMessage,language:null};extensionStates[a]=n,browser.tabs.detectLanguage(a).then(e=>{e&&"und"!==e&&(n.language=getPrimaryLanguageCode(e))}).catch(e=>console.log("Error detecting language",e)),updateBadge(a,n);break}case"VALIDATOR_LOADED":{const t=staticTextValidations[e.id];return staticTextValidations[e.id]=null,Promise.resolve({text:t?t.text:""})}case"EXTENSION_STATUS_CHANGED":{const a=e.tabId||t.tab.id;if(!extensionStates.hasOwnProperty(a))break;const n=extensionStates[a];"enabled"in e&&(n.enabled=e.enabled),"capitalization"in e&&(n.capitalization=e.capitalization),updateBadge(a,n);break}case"SHOW_TURN_ON_HINT":browser.tabs.sendMessage(t.tab.id,{command:"SHOW_TURN_ON_HINT"},{frameId:0});break;case"OPEN_OPTIONS":browser.runtime.openOptionsPage();break;case"OPEN_PRIVACY_CONFIRMATION":browser.tabs.create({url:config.INSTALL_URL});break;case"OPEN_FEEDBACK_FORM":{const t=375,a=500;let n=`/feedbackForm/feedbackForm.html?hostname=${encodeURIComponent(e.hostName)}`;n+=`&url=${encodeURIComponent(e.url||"")}`,e.title&&(n+=`&title=${encodeURIComponent(e.title)}`),browser.windows.create({url:browser.runtime.getURL(n),type:"popup",width:t,height:a}).then(e=>{browser.windows.update(e.id,{left:Math.round(e.left+(screen.availWidth/2-t/2)),top:Math.round(e.top+(screen.availHeight/2-a/2))})});break}case"TRACK_TEXT_LENGTH":Tracker.trackTextLength(e.textLength);break;case"TRACK_EVENT":Tracker.trackEvent("Action",e.action,e.label);break;case"VALIDATE_TEXT":{Tracker.trackActivity();const a=storageController.getUIState().hasPaidSubscription?config.MAX_TEXT_LENGTH_PREMIUM:config.MAX_TEXT_LENGTH;if(e.text.length>=a)return Promise.resolve({command:"VALIDATION_FAILED",instanceId:e.metaData.instanceId,exception:{status:400,message:browser.i18n.getMessage("textTooLong"),response:"Text too long"}});if(0===validationsWithinOneSecond.count&&setTimeout(()=>{validationsWithinOneSecond.count=0,validationsWithinOneSecond.tracked=!1},1e3),validationsWithinOneSecond.count++,validationsWithinOneSecond.count>=5)return validationsWithinOneSecond.tracked||(Tracker.trackEvent("moreThan10RequestsInOneSecond",e.metaData.url),validationsWithinOneSecond.tracked=!0),Promise.resolve({command:"VALIDATION_FAILED",instanceId:e.metaData.instanceId,exception:{message:"Too many requests in one second",response:"Too many requests in one second"}});const n=storageController.getSettings().geoIpLanguages,o=getUserLanguageCodes().concat(n);if(t.tab){const e=extensionStates[t.tab.id];e&&e.language&&o.push(e.language)}e.elementLanguage&&o.push(getPrimaryLanguageCode(e.elementLanguage));const r=storageController.getStatistics().usageCount+1;return storageController.updateStatistics({usageCount:r}),updateUninstallURL(getHostNameFromUrl(e.metaData.url)),Promise.all([Validator.validate(e.text,e.forceLanguage?e.language:null,o,e.metaData,e.hasUserChangedLanguage),Validator.partialValidate(e.changedParagraphs,e.language,o,!e.forceLanguage,e.metaData)]).then(([t,a])=>{const n=t.language||e.language,r=n&&n.name===UNSUPPORTED_LANGUAGE_NAME;return r&&(n.code=o[0]),Promise.resolve({command:"VALIDATION_COMPLETED",instanceId:e.metaData.instanceId,text:e.text,changedParagraphs:e.changedParagraphs,language:n,isUnsupportedLanguage:r,isIncompleteResult:a.isIncompleteResult,validationErrors:t.errors,validationHiddenErrors:t.hiddenErrors,partialValidationErrors:a.errors,partialValidationHiddenErrors:a.hiddenErrors})}).catch(t=>{if(!(t&&"AbortError"===t.reason))return t instanceof Error&&(t={name:t.name,message:t.message,stack:t.stack}),Promise.resolve({command:"VALIDATION_FAILED",instanceId:e.metaData.instanceId,exception:t})})}case"VALIDATE_STATIC_TEXT":validateStaticText(e.text);break;case"CLOSE_CURRENT_TAB":browser.tabs.query({currentWindow:!0,active:!0}).then(e=>{e.length&&browser.tabs.remove(e[0].id)});break;case"SEND_FEEDBACK":fetch("https://languagetoolplus.com/send-feedback/",{method:"POST",mode:"cors",body:JSON.stringify({text:e.text,sender:e.sender})}).catch(()=>{Tracker.trackError("http","error_send_feedback")})}return a(null),!1}function assignToTestGroups(){}function onInstalled(e){const{reason:t,previousVersion:a}=e;storageController.onReady(()=>{if("install"===t)storageController.getPrivacySettings().allowRemoteCheck||storageController.getUIState().hasSeenPrivacyConfirmationDialog||(storageController.updateUIState({hasSeenPrivacyConfirmationDialog:!0}),browser.tabs.create({url:`${config.INSTALL_URL}?new`}),assignToTestGroups(),updateUninstallURL(),getLanguagesForGeoIPCountry().then(e=>{const t={geoIpLanguages:e.geoIpLanguages},a=e.geoIpCountry&&e.geoIpCountry.toUpperCase();"GB"===a?t.enVariant="en-GB":"US"===a?t.enVariant="en-US":"CA"===a?t.enVariant="en-CA":"NZ"===a?t.enVariant="en-NZ":"AU"===a?t.enVariant="en-AU":"ZA"===a?t.enVariant="en-ZA":"DE"===a?t.deVariant="de-DE":"AT"===a?t.deVariant="de-AT":"CH"===a?t.deVariant="de-CH":"BR"===a?t.ptVariant="pt-BR":"PT"===a&&(t.ptVariant="pt-PT"),storageController.updateSettings(t)}).catch(e=>{Tracker.trackError("js",e&&e.message)}),Tracker.trackEvent("Action","install",getPrimaryLanguageCode(navigator.language)));else if("update"===t){assignToTestGroups(),updateUninstallURL();const e=browser.runtime.getManifest(),t=e&&e.version||"unknown";a!==t&&Tracker.trackEvent("Action","update",String(t))}})}function onValidateClicked(e,t){t?browser.tabs.sendMessage(t.id,{command:"GET_SELECTED_TEXT"}).then(e=>{validateStaticText(e.selectedText)}).catch(t=>{validateStaticText(e.selectionText)}):validateStaticText(e.selectionText),storageController.updateUIState({hasUsedValidator:!0})}function onDataLoaded(){storageController.checkForPaidSubscription(),Tracker.trackActivity(),updateUninstallURL()}function updateUninstallURL(e="unknown"){const t=storageController.getSettings(),a=storageController.getPrivacySettings(),n=storageController.getStatistics(),o=(storageController.getTestFlags(),browser.runtime.getManifest()),r=o&&o.version||"unknown";e=e.slice(0,22);let s=`${config.UNINSTALL_URL}?autoCheck=${t.autoCheck}`;s+=`&host=${encodeURIComponent(e)}&v=${r}&privacyConfirmed=${a.allowRemoteCheck}`,s+=`&usages=${n.usageCount}&sessions=${n.sessionCount}`,storageController.uniqueId&&(s+=`&matomo=${storageController.uniqueId}`),s=s.slice(0,255),browser.runtime.setUninstallURL(s)}function validateStaticText(e){const t=Math.round(99999*Math.random())+":"+Date.now();staticTextValidations[t]={id:t,text:e,timestamp:Date.now()},browser.tabs.create({url:browser.runtime.getURL(`/validator/validator.html?id=${t}`)})}browser.contextMenus&&browser.contextMenus.create({title:browser.i18n.getMessage("contextMenuValidate"),contexts:["selection"],onclick:onValidateClicked});