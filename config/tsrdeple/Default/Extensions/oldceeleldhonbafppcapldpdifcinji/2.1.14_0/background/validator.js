/*! (C) Copyright 2018 LanguageTooler GmbH. All rights reserved. */
const FR_PREMIUM_RULES=["AUX_AVOIR_VCONJ","A_ACCENT_A","N_V","TRAIT_UNION_INVERSION","QUASI_NOM","QUI_VCONJ","P_V_PAS","HEURES","AU_DELA","ET_BIEN","ACCORD_V_QUESTION","XXieme","AUX_ETRE_VCONJ","FR_COMPOUNDS","VOIRE_MEME","VACANCE","POSTULER_A","MON_NFS","PAREIL_QUE","A_LE","SE_CE","NOM_MAL_EPELE","T_EUPHONIQUE","FORCEMENT","S_IL_TE_PLAIT","NUL_PART","D_AVANTAGE","COMMENCER_AVEC","FAIRE_PARTI","PARCE","NOTRE","ARRIVEE","ETRE_DANS_LE_MEME_BATEAU","RAPPELER_DE","PEUT_IMPORTE","EN_CAS_OU","CI-ATTACHE","kWh","NORD_SUD","AJOUTER_EN_PLUS","URL","COUR_COURS_COURT","ALIGNER_AVEC","PARTICIPER_DANS","RIM","LA_PLUS_PART","QUANT_QUAND","MILLES","SOI_DISANT","ACCORD_QUEL_QUE_SOIT","DEGOUTTER_DEGOUTER","COMPLETER_UN_FORMULAIRE","GRES_GRE","DE_DAUTRES","MOINS_PIRE","ADJ_ADV_INV","CARNET_DE_CHEQUE","MONTER_EN_HAUT","AUTANT_POUR_MOI","Y_A_T_IL","COMME_PREVU","FOIS_FOIE_FOI","VIEUX","AUX_DEPENDS","DE_TOUTE_FACON","SALE_SALLE"],Validator=function(){const e=["SPELLER_RULE","MORFOLOGIK_RULE","HUNSPELL","SPELLING_RULE"],t=["style","locale-violation","register"];let s=!1,r=!1,o=0;const n={},a={},i={QUOTED_LINE:/^[ \t]*>.*?$/gm,HTML_OPENING_TAG:/<[a-z]+\b[^>]*>/gi,HTML_CLOSING_TAG:/<\/[a-z]+>/gi,MARKDOWN_IMAGE:/!\[.+?\]\(.*?\)/g,MARKDOWN_LINK:/\[.+?\]\(.*?\)/g,BB_OPENING_TAG:/\[(img|url|email|post|quote|list|youtube|vimeo|googlemaps|googlewidget|code|modalurl|topic|highlight|left|center|right|font|size|color|s|u|i|b)\b[^\]]*\]/gi,BB_CLOSING_TAG:/\[\/(img|url|email|post|quote|list|youtube|vimeo|googlemaps|googlewidget|code|modalurl|topic|highlight|left|center|right|font|size|color|s|u|i|b)\]/gi},l=[/(\s|^)(\:\w+\:)(?=\s|[\!\.\?\)]|$)/g,/(\s|^)(\<[\/\\]?3)(?=\s|[\!\.\?]|$)/g,/(\s|^)([\(\)\\D|\*$][\-\^]?[\:\;\=])(?=\s|[\!\.\?]|$)/g,/(\s|^)([\:\;\=B8][\-\^]?[3DOPp\@\$\*\\\)\(\/\|])(?=\s|[\!\.\?\)]|$)/g],c=["jpeg","jpg","gif","png","bmp","svg","ai","sketch","ico","ps","psd","tiff","tif","mp3","wav","midi","mid","aif","mpa","ogg","wma","wpl","cda","7z","arj","deb","pkg","rar","rpm","tar.gz","tar","zip","bin","dmg","iso","toast","vcd","csv","dat","db","log","mdb","sav","sql","xml","apk","bat","bin","cgi","com","exe","gadget","jar","py","js","wsf","fnt","fon","otf","ttf","woff","woff2","rb","java","php","html","asp","aspx","cer","cfm","cgi","pl","css","htm","jsp","part","rss","xhtml","key","odp","pps","ppt","pptx","class","cpp","cs","h","sh","swift","vb","ods","xlr","xls","xlt","xltx","bak","cab","cfg","cpl","cur","dll","dmp","msi","ini","tmp","3g2","3gp","avi","flv","h264","m4v","mkv","mov","mp4","mpg","mpeg","rm","swf","vob","wmv","doc","docx","dot","docx","dotx","pdf","rtf","text","tex","wks","wps","wpd","txt"],g=c.map(e=>new RegExp(`^[\\wäöüß_\\-\\.\\(\\)]*?\\.${e}\\b`,"i")),u=["com","co","org","net","de","info","biz","es","fr","be","in","gov","nl","ca","com.br","br","at","us","au","ru","pl","ly","it","cat","edu","jp","ko","cn","se","no","mil","ch","dk","com.mx","mx","eu","co.uk","uk","ir","cz","ua","kr","gr","tw","nz","co.nz","za","ro","vn","io","tr","me","fi","tv","xyz","pt","ie"],d=u.map(e=>new RegExp(`^\\.${e.replace(".","\\.")}\\b`,"i")),E=new StorageController;return{getUserAgent(){let e="webextension";return isFirefox()?e+="-firefox":isOpera()?e+="-opera":isEdge()?e+="-edge":isChrome()?e+="-chrome":e+="-unknown",e+"-ng"},getServerBaseUrl(e=!1,t=!0){const{apiServerUrl:o}=E.getSettings(),{hasPaidSubscription:n}=E.getUIState(),a=t&&(e?r:s)&&!E.isUsedCustomServer();return n?a?config.FALLBACK_PREMIUM_SERVER_URL:config.PREMIUM_SERVER_URL:a?config.FALLBACK_MAIN_SERVER_URL:o||config.MAIN_SERVER_URL},_getServerFullUrl(e,t=!1,s=!1){let r=this.getServerBaseUrl(t);r+=r.endsWith("/")?"check":"/check",r+=`?instanceId=${encodeURIComponent(e.instanceId)}`,s&&(r+="&languageChanged=true");const o=browser.runtime.getManifest(),n=o&&o.version||"unknown";return r+=`&v=${encodeURIComponent(n)}`},_getRequestData(e,t,s,r){const o=new URLSearchParams,{username:n,password:a,motherTongue:i,enVariant:l,deVariant:c,ptVariant:g,caVariant:u}=E.getSettings(),{hasPaidSubscription:d}=E.getUIState(),_={text:e,metaData:{EmailToAddress:t.recipientInfo.address}};if(o.append("data",JSON.stringify(_)),d&&n&&a&&(o.append("username",n),o.append("password",a)),o.append("textSessionId",t.instanceId),i&&o.append("motherTongue",i),d||o.append("enableHiddenRules",!0),s)o.append("language",s.code);else{o.append("language","auto"),o.append("noopLanguages",uniq(r||[]).join(",")),o.append("preferredLanguages",uniq(r||[]).join(","));const e=[];l&&e.push(l),c&&e.push(c),g&&e.push(g),u&&e.push(u),e.length>0&&o.append("preferredVariants",e.toString())}return o.append("disabledRules","WHITESPACE_RULE"),o.append("useragent",this.getUserAgent()),o},_getValidationRequestData(e,t,s,r){const o=this._getRequestData(e,t,s,r);return o.append("mode","textLevelOnly"),o},_getPartialValidationRequestData(e,t,s,r,o){const n=this._getRequestData(e,t,s,r);return n.append("mode","allButTextLevelOnly"),n.append("allowIncompleteResults",o),n},_sendRequest(e,t,s=config.REQUEST_TIMEOUT){const r=fetch(e,t).catch(t=>{throw"AbortError"===t.name?{reason:"AbortError",status:0,message:"",response:t.message||""}:{reason:"ConnectionError",status:0,message:browser.i18n.getMessage("connectionProblem",e.replace(/\?.*/,""))+" (#1, code="+t.status+")",response:t.message||""}}).then(this._checkForException.bind(this)).then(e=>e.json()),o=new Promise((t,r)=>{setTimeout(()=>{r({reason:"TimeoutError",status:0,message:browser.i18n.getMessage("connectionProblem",e.replace(/\?.*/,""))+" (#1, timeout)",response:""})},s)});return Promise.race([r,o])},_transformMatches:(s,r,o=!1)=>s.map((s,n)=>{const a=e.some(e=>s.rule.id.includes(e)),i=t.some(e=>s.rule.issueType===e);let l="#e3d20d";a?l="#F91A47":i&&(l="#45A8FC");const c=s.context.text.substr(s.context.offset,s.length);let g="";return a&&(g=c),{id:n+1,isPartialValidation:o,language:{code:r.code,name:r.name},rule:s.rule,isSpellingError:a,isSuggestionError:i,offset:s.offset,length:s.length,color:l,context:s.context,sentence:s.sentence,originalPhrase:c,misspelledWord:g,ignoreForIncompleteSentence:s.ignoreForIncompleteSentence,description:s.message,shortDescription:s.shortMessage,fixes:s.replacements}}),_adjustErrors(e,t,s){const r=E.getDomainState(t),o=s.split(" ").filter(e=>e);return e.filter(e=>{if(!r.shouldCapitalizationBeChecked){if(e.fixes.some(t=>t.value.toLowerCase()===e.originalPhrase.toLowerCase()))return!1;if("UPPERCASE_SENTENCE_START"===e.rule.id)return!1}if(e.misspelledWord.match(/^[\-‐]{2,}$/))return!1;if(e.isSpellingError||"WORD_CONTAINS_UNDERSCORE"===e.rule.id){const t=e.originalPhrase.charAt(0),s=e.context.text.substring(Math.max(0,e.context.offset-25),e.context.offset),r=e.context.text.substring(e.context.offset+e.context.length,e.context.offset+e.context.length+25),n=e.originalPhrase.toLowerCase();if(u.some((e,t)=>n.endsWith("."+e)||r.match(d[t])))return!1;if(s.match(/\w\.$/)&&u.includes(n))return!1;if(c.some((e,t)=>n.endsWith("."+e)||r.match(g[t])))return!1;if(s.match(/\w\.$/)&&c.includes(n))return!1;const a="@"===t||s.endsWith("@"),i="#"===t||s.endsWith("#");if(a||i)return!1;if(o.some(t=>t.toLowerCase()===e.originalPhrase.toLowerCase()))return!1;for(const t of o)if(t.toLowerCase()===e.originalPhrase.toLowerCase()&&!e.fixes.some(e=>e.value===t)){e.fixes.unshift({value:t});break}"grammarly"===e.originalPhrase.toLowerCase()&&(e.fixes=[{value:"LanguageTool"}])}return!0})},_transformAndAdjustErrors(e,t,s){let r=this._transformMatches(e.matches,e.language,s);r=this._adjustErrors(r,getHostNameFromUrl(t.url),t.recipientInfo.fullName);let o=[];const{hasPaidSubscription:n}=E.getUIState();return!n&&!E.isUsedCustomServer()&&e.language&&e.language.code.startsWith("fr")&&(r=r.filter(e=>!e.rule.id||!FR_PREMIUM_RULES.includes(e.rule.id)||(o.push(e),!1))),e.hiddenMatches&&(o=o.concat(this._transformMatches(e.hiddenMatches,e.language,s))),{errors:r,hiddenErrors:o}},_ignoreText(e){for(const t in i){const s=i[t];e=e.replace(s,e=>"\ufeff".repeat(e.length))}for(const t of l)e=e.replace(t,(e,t,s)=>`${t}${"\ufeff".repeat(s.length)}`);return e},_checkForException:e=>e.ok?e:e.text().catch(()=>"").then(t=>{var s=t.toLowerCase();if(s.includes("too many error"))throw{status:e.status,message:browser.i18n.getMessage("tooManyErrors"),response:t};if(413===e.status||s.includes("your text exceeds the limit"))throw{status:e.status,message:browser.i18n.getMessage("textTooLong"),response:t};if(t.toLowerCase().includes("checking took longer than"))throw{status:e.status,message:browser.i18n.getMessage("timeoutError",[e.url?e.url.replace(/\?.*/,"?..."):"unknown"]),response:t};if(403===e.status){if(s.includes("client request size limit")||s.includes("client request limit")||s.includes("ip request limit")||s.includes("ip request size limit"))throw{status:e.status,message:browser.i18n.getMessage("tooManyRequests"),response:t};if(s.includes("authexception"))throw{status:e.status,message:browser.i18n.getMessage("invalidUsernameOrPassword"),response:t};throw{status:e.status,message:browser.i18n.getMessage("accessDeniedError2"),response:t}}if(s.includes("checking took longer than"))throw{status:e.status,message:browser.i18n.getMessage("timeoutError",[e.url?e.url.replace(/\?.*/,"?..."):"unknown"]),response:t};throw{status:e.status,message:browser.i18n.getMessage("unknownError")+" ("+e.status+")",response:t}}),_abortValidationRequest(e){n[e]&&n[e].abort()},_abortPartialValidationRequest(e){a[e]&&a[e].abort()},_isConnectionOrServerIssue:e=>config.SWITCH_TO_FALLBACK_SERVER_ERRORS.includes(e.status)||["ConnectionError","TimeoutError"].includes(e.reason),validate(e,t,r,a,i){if(!(e=this._ignoreText(e)).trim()||/^( *\n)* *$/g.test(e))return Promise.resolve({language:t,hiddenErrors:[],errors:[]});this._abortValidationRequest(a.instanceId),n[a.instanceId]=new AbortController,s&&Date.now()-o>=config.MAIN_SERVER_RECHECK_TIME&&(s=!1);const l=this._getServerFullUrl(a,!1,i),c={method:"post",mode:"cors",body:this._getValidationRequestData(e,a,t,r),signal:n[a.instanceId].signal};return this._sendRequest(l,c).then(e=>{const{errors:t,hiddenErrors:s}=this._transformAndAdjustErrors(e,a,!1);return{language:{code:e.language.code,name:e.language.name},errors:t,hiddenErrors:s}}).catch(n=>{if(this._abortValidationRequest(a.instanceId),this._isConnectionOrServerIssue(n)){const i=this.getServerBaseUrl(!1,!1);if(n.message=n.message||browser.i18n.getMessage("connectionProblem",i)+" (#1, code="+n.status+")",!E.isUsedCustomServer()&&!s)return s=!0,o=Date.now(),this.validate(e,t,r,a)}throw n})},partialValidate(e,t,s,n,i){if(e.forEach(e=>{e.text=this._ignoreText(e.text)}),0===e.length)return Promise.resolve({language:t,errors:[],hiddenErrors:[],isIncompleteResult:!1});if(!e.some(e=>!!e.text.trim()))return Promise.resolve({language:t,errors:[],hiddenErrors:[],isIncompleteResult:!1});this._abortPartialValidationRequest(i.instanceId),a[i.instanceId]=new AbortController,r&&Date.now()-o>=config.MAIN_SERVER_RECHECK_TIME&&(r=!1);const l=this._getServerFullUrl(i,!0),c=e.map(e=>e.text).join("\n\n"),g={method:"post",mode:"cors",body:this._getPartialValidationRequestData(c,i,t,s,n),signal:a[i.instanceId].signal};return this._sendRequest(l,g).then(t=>{const{errors:s,hiddenErrors:r}=this._transformAndAdjustErrors(t,i,!0),o=this._correctErrorOffsets(e,s),n=this._correctErrorOffsets(e,r);return{language:{code:t.language.code,name:t.language.name},errors:o,hiddenErrors:n,isIncompleteResult:t.warnings.incompleteResults}}).catch(a=>{if(this._abortPartialValidationRequest(i.instanceId),this._isConnectionOrServerIssue(a)){const l=this.getServerBaseUrl(!0,!1);if(a.message=browser.i18n.getMessage("connectionProblem",l)+" (#2, code="+a.status+")",!E.isUsedCustomServer()&&!r)return r=!0,o=Date.now(),this.partialValidate(e,t,s,n,i)}throw a})},_correctErrorOffsets(e,t){const s=[];let r=0;for(const o of e){const e=o.text.length;for(const n of t)if(n.offset>=r&&n.offset+n.length<=r+e){const e=Object.assign({},n);e.offset=e.offset-r+o.offset,s.push(e)}r+=e+2}return s}}}();"undefined"!=typeof module&&(module.exports=Validator);