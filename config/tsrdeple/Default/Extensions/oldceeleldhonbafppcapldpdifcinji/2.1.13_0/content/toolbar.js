/*! (C) Copyright 2018 LanguageTooler GmbH. All rights reserved. */
function Toolbar(t,e,s=null,o={requestStatus:REQUEST_STATUS.IN_PROGRESS,errorsCount:0,hiddenErrorsCount:0,isIncompleteResult:!1,languageName:"",exceptionMessage:""}){this._input=t,this._settings=e,this._mirror=s,this._visible=!1,this._sizeDecreased=!1,this._eventListeners=[],this._controls={container:null,wrapper:null,statusIcon:null},this._domMeasurement=new DomMeasurement(t.ownerDocument),this.updateState(o),this._renderInterval=setAnimationFrameInterval(bindAndCatch(()=>this._updateDisplaying(!0)),config.RENDER_INTERVAL),this._decreaseSizeInterval=setAnimationFrameInterval(bindAndCatch(()=>this._decreaseSizeIfNeeded()),config.DECREASE_SIZE_INTERVAL),this._scrollObserver=observeScrollableAncestors(t,bindAndCatch(()=>this._updateDisplaying(!1)))}Toolbar.messages={STATUS_ICON_RELOAD_MESSAGE:browser.i18n.getMessage("statusIconReload"),STATUS_ICON_TOOLTIP:browser.i18n.getMessage("statusIconToolTip"),STATUS_ICON_PERMISSION_REQUIRED:browser.i18n.getMessage("statusIconPermissionRequired"),STATUS_ICON_TEXT_TOO_LONG:browser.i18n.getMessage("textTooLong"),STATUS_ICON_DISABLED:browser.i18n.getMessage("statusIconEnableLT"),STATUS_ICON_FAIL:browser.i18n.getMessage("statusIconError"),STATUS_ICON_MORE_ERRORS:browser.i18n.getMessage("statusIconMoreErrors")},Toolbar.CONTAINER_ELEMENT_NAME="lt-toolbar",Toolbar.eventNames={permissionRequiredIconClicked:"lt-toolbar.permissionRequiredIconClicked",toggleDialog:"lt-toolbar.toggleDialog",notifyAboutPremiumIcon:"lt-toolbar.notifyAboutPremiumIcon"},Toolbar.prototype=function(){function t(t,e){return!(e.left>t.right||e.top>t.bottom||e.bottom<t.top)}return{_render(){const t=["lt-toolbar__status-icon"],e=["lt-toolbar__premium-icon"];let s=Toolbar.messages.STATUS_ICON_TOOLTIP,o="";switch(this._controls.container||(this._rootElement="BODY"===this._input.tagName?document.documentElement:document.body,this._controls.container=document.createElement(Toolbar.CONTAINER_ELEMENT_NAME),this._controls.container.setAttribute("contenteditable","false"),this._controls.wrapper=document.createElement("lt-div"),this._controls.wrapper.className="lt-toolbar__wrapper",this._controls.statusIcon=document.createElement("lt-div"),this._controls.premiumIcon=document.createElement("lt-div"),[this._controls.statusIcon,this._controls.premiumIcon].forEach(t=>{this._eventListeners.push(addUseCaptureEvent(t,"mousedown",t=>{t.stopImmediatePropagation(),t.preventDefault()}),addUseCaptureEvent(t,"mouseup",t=>{t.stopImmediatePropagation()}),addUseCaptureEvent(t,"pointerdown",t=>{t.stopImmediatePropagation()}),addUseCaptureEvent(t,"pointerup",t=>{t.stopImmediatePropagation()}))}),this._eventListeners.push(addUseCaptureEvent(this._controls.statusIcon,"click",this._onStatusIconClick.bind(this)),addUseCaptureEvent(this._controls.premiumIcon,"click",this._onStatusIconClick.bind(this))),this._controls.wrapper.appendChild(this._controls.premiumIcon),this._controls.wrapper.appendChild(this._controls.statusIcon),this._controls.container.appendChild(this._controls.wrapper),this._visible=!0),clearTimeout(this._premiumIconTimeout),this._state.requestStatus){case REQUEST_STATUS.IN_PROGRESS:t.push("lt-toolbar__status-icon-in-progress");break;case REQUEST_STATUS.COMPLETED:0===this._state.errorsCount?t.push("lt-toolbar__status-icon-has-no-errors"):(t.push("lt-toolbar__status-icon-has-errors"),this._state.isIncompleteResult?(t.push("lt-toolbar__status-icon-has-more-errors"),s=Toolbar.messages.STATUS_ICON_MORE_ERRORS):this._state.errorsCount>=9?t.push("lt-toolbar__status-icon-has-9plus-errors"):t.push(`lt-toolbar__status-icon-has-${this._state.errorsCount}-errors`)),this._state.hiddenErrorsCount>0&&(e.push("lt-toolbar__premium-icon--visible"),this._premiumIconTimeout=setTimeout(()=>this._notifyAboutPremiumIcon(),3e3),this._state.hiddenErrorsCount<9?e.push(`lt-toolbar__premium-icon-has-${this._state.hiddenErrorsCount}-errors`):e.push("lt-toolbar__premium-icon-has-9plus-errors"),0===this._state.errorsCount&&e.push("lt-toolbar__premium-icon--prominent"));break;case REQUEST_STATUS.UNSUPPORTED_LANGUAGE:t.push("lt-toolbar__status-icon-unsupported-language"),s=browser.i18n.getMessage("statusIconUnsupportedLanguage",this._state.languageName),o="!";break;case REQUEST_STATUS.TEXT_TOO_LONG:t.push("lt-toolbar__status-icon-text-too-long"),s=Toolbar.messages.STATUS_ICON_TEXT_TOO_LONG;break;case REQUEST_STATUS.FAILED:t.push("lt-toolbar__status-icon-failed"),s=this._state.exceptionMessage||Toolbar.messages.STATUS_ICON_FAIL,o="✖";break;case REQUEST_STATUS.PERMISSION_REQUIRED:t.push("lt-toolbar__status-icon-permission-required"),s=Toolbar.messages.STATUS_ICON_PERMISSION_REQUIRED,o="!";break;case REQUEST_STATUS.DISABLED:t.push("lt-toolbar__status-icon-disabled"),s=Toolbar.messages.STATUS_ICON_DISABLED;break;case REQUEST_STATUS.DISCONNECTED:t.push("lt-toolbar__status-icon-disconnected"),s=Toolbar.messages.STATUS_ICON_RELOAD_MESSAGE,o="✖"}this._controls.statusIcon.className=t.join(" "),this._controls.statusIcon.title=s,this._controls.statusIcon.textContent=o,this._controls.premiumIcon.className=e.join(" "),this._rootElement&&this._rootElement.children[this._rootElement.children.length-1]!==this._controls.container&&this._rootElement.appendChild(this._controls.container)},_updateDisplaying(t=!1){if(this._domMeasurement.clearCache(),!this._settings.isVisible(this._input,this._domMeasurement))return void this._hide();const e=this._settings.getPosition(this._input,20,20,this._domMeasurement);if(!e)return void this._hide();const s={left:e.left};e.fixed?(s.position="fixed !important",s.top="auto !important",s.bottom="12px !important"):(s.position="absolute !important",s.top=`${e.top} !important`,s.bottom="auto !important"),t&&(s["z-index"]=this._domMeasurement.getZIndex(this._input).toString()),this._domMeasurement.setStyles(this._controls.wrapper,s),this._show()},_hide(){this._visible&&(this._visible=!1,this._controls.wrapper.classList.add("lt-toolbar__wrapper-hide"))},_show(){this._visible||(this._visible=!0,this._controls.wrapper.classList.remove("lt-toolbar__wrapper-hide"))},_decreaseSizeIfNeeded(){if(!this._visible||!this._controls.wrapper)return;const e=this._domMeasurement.getBorderBox(this._controls.wrapper,!1);if(e.top<0||e.bottom>window.innerHeight)return;const s=Math.round(e.left+e.width/2),o={top:Math.round(e.top),left:e.left},r={top:Math.round(e.top+e.height/2),left:s},i={top:Math.round(e.bottom),left:e.left};this.disableRangeMeasurements(),this._mirror&&this._mirror.enableRangeMeasurements();const n=this._mirror?this._mirror.getCloneElement():this._input,a=getRangeAtPoint(o.left,o.top),l=getRangeAtPoint(r.left,r.top),_=getRangeAtPoint(i.left,i.top);this.enableRangeMeasurements(),this._mirror&&this._mirror.disableRangeMeasurements();let u=null;l&&l.startOffset>0&&((u=new Range).setStart(l.startContainer,l.startOffset-1),u.setEnd(l.startContainer,l.startOffset-1));const c={left:e.left-7,top:e.top,right:e.right,bottom:e.bottom};if(a&&contains(n,a.startContainer)){if(t(a.getBoundingClientRect(),c))return void this._decreaseSize()}if(l&&!isSameRange(a,l)&&contains(n,l.startContainer)){if(t(l.getBoundingClientRect(),c))return void this._decreaseSize()}if(_&&!isSameRange(a,_)&&!isSameRange(l,_)&&contains(n,_.startContainer)){if(t(_.getBoundingClientRect(),c))return void this._decreaseSize()}if(u&&!isSameRange(a,u)&&!isSameRange(l,u)&&!isSameRange(_,u)){if(t(u.getBoundingClientRect(),c))return void this._decreaseSize()}this._increaseSize()},_decreaseSize(){this._sizeDecreased||(this._sizeDecreased=!0,this._controls.wrapper.classList.add("lt-toolbar-small"))},_increaseSize(){this._sizeDecreased&&(this._sizeDecreased=!1,this._controls.wrapper.classList.remove("lt-toolbar-small"))},_onStatusIconClick(t){t.stopImmediatePropagation();const e={toolbar:this};if(this._state.requestStatus===REQUEST_STATUS.PERMISSION_REQUIRED)dispatchCustomEvent(Toolbar.eventNames.permissionRequiredIconClicked,e);else{let t=this._state.requestStatus;t===REQUEST_STATUS.COMPLETED&&this._state.errorsCount>0?t="HAS_ERRORS":t===REQUEST_STATUS.COMPLETED&&this._state.hiddenErrorsCount>0&&(t="HAS_ONLY_PREMIUM_ERRORS"),Tracker.trackEvent("Action","dialog:opened",t),dispatchCustomEvent(Toolbar.eventNames.toggleDialog,e)}},_notifyAboutPremiumIcon(){if(this._hasNotifiedAboutPremiumIcon)return;this._hasNotifiedAboutPremiumIcon=!0;const t={toolbar:this};dispatchCustomEvent(Toolbar.eventNames.notifyAboutPremiumIcon,t)},updateState(t){if(isSameObject(this._stateForComparison,t))return;this._stateForComparison=t;const e=void 0===t.requestStatus?this._state.requestStatus:t.requestStatus;let s=0,o=0;e===REQUEST_STATUS.COMPLETED&&(s=void 0===t.errorsCount?this._state.errorsCount:t.errorsCount,o=void 0===t.errorsCount?this._state.hiddenErrorsCount:t.hiddenErrorsCount);let r=void 0===t.isIncompleteResult?this._state.isIncompleteResult:t.isIncompleteResult,i="";e===REQUEST_STATUS.UNSUPPORTED_LANGUAGE&&(i=void 0===t.languageName?this._state.languageName:t.languageName);let n="";e===REQUEST_STATUS.FAILED&&(n=void 0===t.exceptionMessage?this._state.exceptionMessage:t.exceptionMessage),this._state={requestStatus:e,errorsCount:s,hiddenErrorsCount:o,isIncompleteResult:r,languageName:i,exceptionMessage:n},window.requestAnimationFrame(()=>{this._render(),this._updateDisplaying()})},enableRangeMeasurements(){this._controls.wrapper.classList.remove("lt-toolbar-disable-range-measurement")},disableRangeMeasurements(){this._controls.wrapper.classList.add("lt-toolbar-disable-range-measurement")},getState(){return this._state},getContainer(){return this._controls.wrapper},destroy(){clearTimeout(this._premiumIconTimeout),this._eventListeners.forEach(t=>{t.destroy()}),this._eventListeners=[];for(const t in this._controls)this._controls[t]&&this._controls[t].remove();this._controls={},this._scrollObserver.destroy(),this._renderInterval&&this._renderInterval.destroy(),this._decreaseSizeInterval&&this._decreaseSizeInterval.destroy(),this._domMeasurement.clearCache()}}}();