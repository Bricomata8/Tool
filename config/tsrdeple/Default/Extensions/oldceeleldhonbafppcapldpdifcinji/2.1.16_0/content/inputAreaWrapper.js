/*! (C) Copyright 2018 LanguageTooler GmbH. All rights reserved. */
class InputAreaWrapper{constructor(e,t,r){if(this._inputAreaObserver=null,this._scrollToInterval=null,this._inputArea=t,this._ceElement=e,this._parsingDetector=r,this._nodePropertiesCache=new Map,this._updateTextParts(),this._currentText=this.getText(),this._domMeasurement=new DomMeasurement(this._inputArea.ownerDocument),this._scrollToInterval=null,this._onScroll=bindAndCatch(this._onScroll,this),this._onBlur=bindAndCatch(this._onBlur,this),this._onPaste=bindAndCatch(this._onPaste,this),this._onClick=bindAndCatch(this._onClick,this),this._onInput=bindAndCatch(this._onInput,this),this._inputArea.addEventListener("scroll",this._onScroll),this._inputArea.addEventListener("blur",this._onBlur),this._inputArea.addEventListener("paste",this._onPaste),this._inputArea.addEventListener("click",this._onClick),this._ceElement.addEventListener(Mirror.eventNames.input,this._onInput),this._scrollTop=this._inputArea.scrollTop,this._scrollLeft=this._inputArea.scrollLeft,"TEXTAREA"!==this._inputArea.tagName){this._inputAreaObserver=new MutationObserver(this._onInput);const e={attributes:!1,attributeOldValue:!1,characterData:!0,characterDataOldValue:!1,childList:!0,subtree:!0};this._inputAreaObserver.observe(this._inputArea,e)}try{if(Math.random()<.1){const e=t.parentNode,r=getCurrentUrl().replace(/(\?|#).*/,"");e.shadowRoot?Tracker.trackEvent("Info","shadow:open",r):e.openOrClosedShadowRoot&&Tracker.trackEvent("Info","shadow:closed",r)}}catch(e){}}static _replaceLineBreaks(e){return e.replace(InputAreaWrapper.LINE_BREAKS_REGEXP," ")}static _replaceWhitespaces(e){return e.replace(InputAreaWrapper.WHITESPACES_REGEXP," ")}static _removeZWS(e){return e.replace(InputAreaWrapper.ZWS_REGEXP,"")}static _indexWithZWS(e,t){let r=0;for(;t>0&&r<e.length;)e[r]!==InputAreaWrapper.ZWS&&t--,r++;return r}static _isBlankString(e){return!e.trim()}static _appendTrailingLineBreak(e){return e&&"\n"===e[e.length-1]||(e+="\n"),e}static _selectText(e,t=0,r=e.nodeValue.length){t=Math.max(t,0),r=Math.min(r,e.nodeValue.length);const n=window.getSelection();n.empty();const s=new Range;s.setStart(e,t),s.setEnd(e,r),n.addRange(s)}static _simulateSelection(e){const t=window.getSelection();t.empty();const r=new Range;r.setStart(e,0),r.collapse(),t.addRange(r);const n=new MouseEvent("mousedown",{bubbles:!0,cancelable:!1}),s=new MouseEvent("mouseup",{bubbles:!0,cancelable:!1});e.dispatchEvent(n),e.dispatchEvent(s)}static _applyReplacement(e,t=!0){let r=Promise.resolve();return t&&(r=r.then(()=>InputAreaWrapper._simulateSelection(e.textNode.parentNode)).then(()=>wait())),r=r.then(()=>{const t=InputAreaWrapper._indexWithZWS(e.textNode.nodeValue,e.offset),r=InputAreaWrapper._indexWithZWS(e.textNode.nodeValue,e.offset+e.length);InputAreaWrapper._selectText(e.textNode,t,r)}).then(()=>document.execCommand("insertText",!1,e.replacementText)),isFirefox()&&e.replacementText.includes(InputAreaWrapper.NBSP)&&(r=r.then(()=>e.textNode.nodeValue=e.newText)),r}_getCacheForNode(e){let t=this._nodePropertiesCache.get(e);return t||(t={},this._nodePropertiesCache.set(e,t)),t}_getComputedStyle(e){const t=this._getCacheForNode(e);return"computedStyle"in t?t.computedStyle:(t.computedStyle=window.getComputedStyle(e),t.computedStyle)}_isSkippingElement(e){const t=this._getCacheForNode(e);return"isSkippingElement"in t?t.isSkippingElement:(t.isSkippingElement=this._ceElement!==e&&(InputAreaWrapper.SKIPPING_TAGS.includes(e.tagName)||"false"===e.getAttribute("contenteditable")||"false"===e.getAttribute("spellcheck")||this._parsingDetector.isQuote(e)||this._parsingDetector.isSignature(e)),t.isSkippingElement)}_isBlock(e){const t=this._getCacheForNode(e);if("isBlock"in t)return t.isBlock;if(isElementNode(e)){const r=this._getComputedStyle(e);t.isBlock=InputAreaWrapper.DISPLAY_BLOCK_VALUES.includes(r.display||"")}else t.isBlock=!1;return t.isBlock}_isBr(e){const t=this._getCacheForNode(e);return"isBr"in t?t.isBr:(t.isBr="BR"===e.tagName,t.isBr)}_getParsingOptions(e){const t=this._getCacheForNode(e);if("parsingOptions"in t)return t.parsingOptions;const r=isElementNode(e)?e:e.parentNode,n=this._getComputedStyle(r).whiteSpace;return t.parsingOptions={preserveLineBreaks:InputAreaWrapper.PRESERVE_LINEBREAKS_VALUES.includes(n||""),preserveWhitespaces:InputAreaWrapper.PRESERVE_WHITESPACES_VALUES.includes(n||"")},t.parsingOptions}_getBlockParent(e){const t=this._getCacheForNode(e);if("blockParent"in t)return t.blockParent;let r=e.parentElement;for(;r!==this._ceElement&&!this._isBlock(r);)r=r.parentElement;return t.blockParent=r,t.blockParent}_getParsedText(e){const t=this._getCacheForNode(e);if("parsedText"in t)return t.parsedText;const r=this._getParsingOptions(e);let n=e.nodeValue;return r.preserveLineBreaks||(n=InputAreaWrapper._replaceLineBreaks(n)),n=InputAreaWrapper._removeZWS(n),n=InputAreaWrapper._replaceWhitespaces(n),t.parsedText=n,t.parsedText}_isLastTextInParagraph(e){const t=this._getCacheForNode(e);if("isLastTextInParagraph"in t)return t.isLastTextInParagraph;t.isLastTextInParagraph=!0;const r=this._getBlockParent(e),n=new DOMWalker(r,e);n.next();e:for(;n.node();){const e=n.node();if(isElementNode(e))if(this._isSkippingElement(e))n.next(!0);else{if(this._isBr(e))break e;if(this._isBlock(e))break e;n.next()}else if(isTextNode(e)){if(this._getParsedText(e)){t.isLastTextInParagraph=!1;break e}n.next()}else n.next()}return t.isLastTextInParagraph}_isParagraphEndsWithLineBreak(e){const t=this._getCacheForNode(e);if("isParagraphEndsWithLineBreak"in t)return t.isParagraphEndsWithLineBreak;t.isParagraphEndsWithLineBreak=!1;const r=this._getBlockParent(e),n=new DOMWalker(this._ceElement,e);e:for(;n.node();){const e=n.node();if(isElementNode(e))if(this._isSkippingElement(e))n.next(!0);else{if(this._isBr(e)){t.isParagraphEndsWithLineBreak=!0;break e}if(this._isBlock(e)&&this._isParagraphNonEmpty(e)){t.isParagraphEndsWithLineBreak=!0;break e}n.next()}else if(isTextNode(e)){if(!contains(r,e)){const r=this._getParsingOptions(e),n=this._getParsedText(e);if(r.preserveWhitespaces&&n||!InputAreaWrapper._isBlankString(n)){t.isParagraphEndsWithLineBreak=!0;break e}}n.next()}else n.next()}return t.isParagraphEndsWithLineBreak}_isParagraphNonEmpty(e){const t=this._getCacheForNode(e);if("isParagraphNonEmpty"in t)return t.isParagraphNonEmpty;t.isParagraphNonEmpty=!1;const r=new DOMWalker(e);r.next();e:for(;r.node();){const e=r.node();if(isElementNode(e))if(this._isSkippingElement(e))r.next(!0);else{if(this._isBr(e))break e;if(this._isBlock(e))break e;r.next()}else if(isTextNode(e)){const n=this._getParsingOptions(e),s=this._getParsedText(e);if(n.preserveWhitespaces&&s||!InputAreaWrapper._isBlankString(s)){t.isParagraphNonEmpty=!0;break e}r.next()}else r.next()}return t.isParagraphNonEmpty}_updateTextParts(){this._nodePropertiesCache.clear();const e=new DOMWalker(this._ceElement),t=[];let r=0;do{const n=e.node();let s="",i="";if(isElementNode(n)){if(this._isSkippingElement(n)){e.next(!0);continue}this._isBr(n)&&(i="\n")}else isTextNode(n)&&(s=n.nodeValue,(i=this._getParsedText(n))&&this._isLastTextInParagraph(n)&&this._isParagraphEndsWithLineBreak(n)&&(i=InputAreaWrapper._appendTrailingLineBreak(i)));if(t.push({node:n,rawText:s,parsedText:i}),(r+=i.length)>config.MAX_TEXT_LENGTH_PREMIUM)break;e.next()}while(e.node());this._textParts=t}_getTextPosition(e){const t=this.getTextParts();for(const{node:r,parsedText:n,rawText:s}of t){if(isTextNode(r)&&e<=n.length)return{textNode:r,offset:InputAreaWrapper._indexWithZWS(s,e)};e-=n.length}return null}_getTextOffset(e,t){const r=this.getTextParts();let n=0;for(const t of r){if(t.node===e)break;n+=t.parsedText.length}return n+(t-(e.nodeValue||"").substring(0,t).split("").reduce((e,t)=>t===InputAreaWrapper.ZWS?e+1:e,0))}_onScroll(){const e=this._inputArea.scrollTop,t=this._inputArea.scrollLeft;if(this._scrollTop===e&&this._scrollLeft===t)return;this._scrollTop=e,this._scrollLeft=t;const r={inputAreaWrapper:this};dispatchCustomEvent(InputAreaWrapper.eventNames.scroll,r)}_onPaste(){const e={inputAreaWrapper:this};dispatchCustomEvent(InputAreaWrapper.eventNames.paste,e)}_onBlur(){const e={inputAreaWrapper:this};dispatchCustomEvent(InputAreaWrapper.eventNames.blur,e)}_onClick(){const e={inputAreaWrapper:this};dispatchCustomEvent(InputAreaWrapper.eventNames.click,e)}_onInput(){this._updateTextParts();const e=this.getText();if(this._currentText===e)return;this._currentText=e;const t={inputAreaWrapper:this,text:e};dispatchCustomEvent(InputAreaWrapper.eventNames.textChanged,t)}getText(){return this.getTextParts().map(e=>e.parsedText).join("")}getTextParts(){return this._textParts}getTextRanges(e,t){const r=[],n=this.getTextParts();for(const{node:s,parsedText:i,rawText:a}of n)if(isTextNode(s)){if(0===e){const n=InputAreaWrapper._indexWithZWS(a,e),o=InputAreaWrapper._indexWithZWS(a,t);r.push({textNode:s,start:n,end:o}),t-=i.length}else if(e<i.length){const n=InputAreaWrapper._indexWithZWS(a,e),o=InputAreaWrapper._indexWithZWS(a,e+t);r.push({textNode:s,start:n,end:o}),t-=i.length-e,e=0}else e-=i.length;if(t<=0)break}else e-=i.length;return r}replaceText(e,t,r){const n=e+r.length;if(this._inputArea instanceof HTMLTextAreaElement){this.setSelection({start:e,end:e+t});const s=document.execCommand("insertText",!1,r),i=isFirefox()&&r.includes(InputAreaWrapper.NBSP);if(s){if(i){const t=this._inputArea.value,n=t.substring(0,e)+r+t.substring(e+r.length);this._inputArea.value=n}}else{const n=this._inputArea.value,s=n.substring(0,e)+r+n.substring(e+t);this._inputArea.value=s}return this.setSelection({start:n}),s||this.simulateInput(r),Promise.resolve()}{const s=Promise.resolve(),i=!isTinyMCE(this._inputArea);return i&&s.then(()=>InputAreaWrapper._simulateSelection(this._inputArea)),s.then(()=>wait(50)).then(()=>{const s=this.getTextParts(),a=[];for(let n=0;n<s.length;n++){const{node:i,parsedText:o}=s[n];if(isTextNode(i)&&e<o.length){let n=Math.min(o.length-e,r.length);e+t<=o.length&&(n=r.length);const s=o.substr(0,e)+r.substr(0,n)+o.substr(e+t);i.nodeValue!==s&&a.push({textNode:i,offset:e,length:t,replacementText:r.substr(0,n),newText:s}),t=Math.max(e+t-o.length,0),e=0,r=r.substr(n)}else e-=o.length;if(0===t&&""===r)break}a.reverse().reduce((e,t)=>e.then(()=>InputAreaWrapper._applyReplacement(t,i)),Promise.resolve()).then(()=>{this.setSelection({start:n})}).then(()=>this.simulateInput(r))})}}simulateInput(e=""){if(window.InputEvent){const t=new window.InputEvent("input",{bubbles:!0,cancelable:!1,inputType:"insertText",data:e});this._inputArea.dispatchEvent(t)}const t=new Event("change",{bubbles:!0,cancelable:!1});this._inputArea.dispatchEvent(t)}getSelection(){if(this._inputArea instanceof HTMLTextAreaElement)return this._inputArea!==document.activeElement?null:{start:this._inputArea.selectionStart,end:this._inputArea.selectionEnd};{const e=window.getSelection();if(!e.anchorNode)return null;if(!this._inputArea.contains(e.anchorNode))return null;const t=this._getTextOffset(e.anchorNode,e.anchorOffset);return{start:t,end:e.isCollapsed?t:this._getTextOffset(e.focusNode,e.focusOffset)}}}setSelection(e){if(e={start:e.start,end:void 0===e.end?e.start:e.end},this._inputArea.focus(),this._inputArea instanceof HTMLTextAreaElement)this._inputArea.selectionStart=e.start,this._inputArea.selectionEnd=e.end;else{const t=this._getTextPosition(e.start);if(!t)return;const r=window.getSelection();r.removeAllRanges();const n=new Range;if(n.setStart(t.textNode,t.offset),e.start!==e.end){const t=this._getTextPosition(e.end);if(!t)return;n.setEnd(t.textNode,t.offset)}else n.collapse();r.addRange(n)}}scrollToText(e,t,r=300){function n(e,t,r,n){return(e/=n/2)<1?r/2*e*e+t:-r/2*(--e*(e-2)-1)+t}if(this._inputArea instanceof HTMLTextAreaElement){this._scrollToInterval&&(this._scrollToInterval.destroy(),this._scrollToInterval=null);const s=this.getTextRanges(e,t),i={top:this._inputArea.scrollTop,left:this._inputArea.scrollLeft};this._domMeasurement.clearCache();const a=this._domMeasurement.getTextBoundingBox(s,this._ceElement),o=this._inputArea.getBoundingClientRect();let p=a.top;o.top<0&&(p+=o.top);let l=Math.max(0,a.right-o.width);o.left<0&&(l+=o.left);const h=i.top,c=i.left,u=p-h,_=l-c;let d=0;this._scrollToInterval=setAnimationFrameInterval(()=>{const e=n(d+=InputAreaWrapper.SCROLL_TO_FRAME_INTERVAL,h,u,r),t=n(d,c,_,r);this._inputArea.scrollTop=e,this._inputArea.scrollLeft=t,d>=r&&this._scrollToInterval&&(this._scrollToInterval.destroy(),this._scrollToInterval=null)},InputAreaWrapper.SCROLL_TO_FRAME_INTERVAL)}else{const t=this._getTextPosition(e);t&&t.textNode.parentElement.scrollIntoView({behavior:"smooth",block:"nearest"})}}destroy(){this._inputArea.removeEventListener("scroll",this._onScroll),this._inputArea.removeEventListener("blur",this._onBlur),this._inputArea.removeEventListener("paste",this._onPaste),this._inputArea.removeEventListener("click",this._onClick),this._ceElement.removeEventListener(Mirror.eventNames.input,this._onInput),this._scrollToInterval&&this._scrollToInterval.destroy(),this._inputAreaObserver&&this._inputAreaObserver.disconnect()}}InputAreaWrapper.eventNames={textChanged:"lt-inputAreaWrapper.textChanged",scroll:"lt-inputAreaWrapper.scroll",paste:"lt-inputAreaWrapper.paste",blur:"lt-inputAreaWrapper.blur",click:"lt-inputAreaWrapper.click"},InputAreaWrapper.SCROLL_TO_FRAME_INTERVAL=20,InputAreaWrapper.NBSP=String.fromCharCode(160),InputAreaWrapper.ZWS=String.fromCharCode(8203),InputAreaWrapper.WHITESPACES=[8,9,32,8194,8195,8196,8197,8198,8199,8200,8201,8202,8203,8287,12288].map(function(e){return String.fromCharCode(e)}),InputAreaWrapper.SKIPPING_TAGS=["CODE","NOSCRIPT","OBJECT","SCRIPT","STYLE","TEMPLATE","VAR","CANVAS","IMG","SVG","BLOCKQUOTE"],InputAreaWrapper.DISPLAY_BLOCK_VALUES=["block","list-item","table","table-caption","table-row","table-cell","flex","grid"],InputAreaWrapper.PRESERVE_LINEBREAKS_VALUES=["pre","pre-wrap","pre-line"],InputAreaWrapper.PRESERVE_WHITESPACES_VALUES=["pre","pre-wrap"],InputAreaWrapper.LINE_BREAKS_REGEXP=/\n/g,InputAreaWrapper.WHITESPACES_REGEXP=new RegExp("["+InputAreaWrapper.WHITESPACES.join("")+"]","g"),InputAreaWrapper.ZWS_REGEXP=new RegExp(InputAreaWrapper.ZWS,"g");