/*! (C) Copyright 2018 LanguageTooler GmbH. All rights reserved. */
class Dialog{constructor(e,t,n,o){this._toolbarContainer=e,this._uiState=o,this._controls={},this._eventListeners=[],this._render(),this.setCurrentLanguage(t||getDefaultLanguage()),this.updateState(n),this._eventListeners.push(addUseCaptureEvent(document,"keydown",this._onKeydown.bind(this))),this._inApplyFixMode=!1}_render(){if(this._controls.container)return;this._controls.container=document.createElement(Dialog.CONTAINER_ELEMENT_NAME),this._controls.container.setAttribute("contenteditable","false");const e=e=>{e.stopImmediatePropagation()};this._eventListeners.push(addUseCaptureEvent(this._controls.container,"mousedown",e),addUseCaptureEvent(this._controls.container,"mouseup",e),addUseCaptureEvent(this._controls.container,"pointerdown",e),addUseCaptureEvent(this._controls.container,"pointerup",e),addUseCaptureEvent(this._controls.container,"focusin",e),addUseCaptureEvent(this._controls.container,"focusout",e)),this._controls.container.addEventListener("click",e),this._controls.innerContainer=document.createElement("lt-div"),this._controls.innerContainer.className="lt-dialog__container",this._controls.container.appendChild(this._controls.innerContainer),this._controls.header=document.createElement("lt-div"),this._controls.header.className="lt-dialog__header",this._controls.innerContainer.appendChild(this._controls.header),this._controls.languageSelectorWrapper=document.createElement("lt-div"),this._controls.languageSelectorWrapper.className="lt-dialog__language-selector-wrapper",this._controls.header.appendChild(this._controls.languageSelectorWrapper),this._controls.currentLanguage=document.createElement("lt-span"),this._controls.currentLanguage.className="lt-dialog__current-language",this._controls.languageSelectorWrapper.appendChild(this._controls.currentLanguage),this._controls.languageSelector=document.createElement("select"),this._controls.languageSelector.className="lt-dialog__language-selector",this._eventListeners.push(addUseCaptureEvent(this._controls.languageSelector,"change",this._onLanguageChange.bind(this))),LANGUAGES.forEach(e=>{const t=document.createElement("option");t.value=e.code,t.textContent=e.name,this._controls.languageSelector.appendChild(t)}),this._controls.languageSelectorWrapper.appendChild(this._controls.languageSelector),this._controls.settingsLink=document.createElement("lt-span"),this._controls.settingsLink.className="lt-dialog__settings-link",this._controls.settingsLink.title=Dialog.MESSAGES.SETTINGS_TITLE,this._eventListeners.push(addUseCaptureEvent(this._controls.settingsLink,"click",this._onSettingsClick.bind(this))),this._controls.header.appendChild(this._controls.settingsLink),this._controls.content=document.createElement("lt-div"),this._controls.content.className="lt-dialog__content",this._controls.innerContainer.appendChild(this._controls.content),this._controls.footer=document.createElement("lt-div"),this._controls.footer.className="lt-dialog__footer",this._controls.innerContainer.appendChild(this._controls.footer),this._controls.incompleteResult=document.createElement("lt-div"),this._controls.incompleteResult.className="lt-dialog__incomplete-result",this._controls.incompleteResult.textContent=Dialog.MESSAGES.INCOMPLETE_RESULT,this._controls.footer.appendChild(this._controls.incompleteResult),this._controls.poweredBy=document.createElement("lt-span"),this._controls.poweredBy.className="lt-dialog__powered-by",this._controls.poweredBy.innerHTML=Dialog.MESSAGES.POWERED_BY,this._eventListeners.push(addUseCaptureEvent(this._controls.poweredBy,"click",this._gotoLanguageTool.bind(this))),this._controls.footer.appendChild(this._controls.poweredBy),this._controls.sendFeedback=document.createElement("lt-span"),this._controls.sendFeedback.className="lt-dialog__send-feedback",this._controls.sendFeedback.innerHTML=Dialog.MESSAGES.FEEDBACK,this._eventListeners.push(addUseCaptureEvent(this._controls.sendFeedback,"click",this._showFeedbackForm.bind(this))),this._controls.footer.appendChild(this._controls.sendFeedback),this._controls.pointer=document.createElement("lt-span"),this._controls.pointer.className="lt-dialog__pointer",this._controls.innerContainer.appendChild(this._controls.pointer),this._toolbarContainer.appendChild(this._controls.container),this._toolbarContainer.classList.add("lt-toolbar--dialog-opened")}_position(){const e=new DomMeasurement(document);let t=this._controls.innerContainer.getBoundingClientRect();t.right>=document.documentElement.clientWidth-Dialog.SPACE_TO_SCREEN_EDGE&&this._alignToBottom(),(t=this._controls.innerContainer.getBoundingClientRect()).bottom+t.height>=document.documentElement.clientHeight&&this._alignToTop();const n=e.getDocumentScroll();t=this._controls.innerContainer.getBoundingClientRect(),n.top+t.top<=Dialog.SPACE_TO_SCREEN_EDGE&&this._alignToBottom()}_alignToBottom(){const e=new DomMeasurement(document);this._controls.innerContainer.classList.remove("lt-dialog__container-top"),this._controls.innerContainer.classList.add("lt-dialog__container-bottom");const t=this._controls.innerContainer.getBoundingClientRect();if(t.left<=Dialog.SPACE_TO_SCREEN_EDGE){const n=parseInt(e.getStyle(this._controls.innerContainer,"right"),10)+t.left-Dialog.SPACE_TO_SCREEN_EDGE,o=parseInt(e.getStyle(this._controls.pointer,"right"),10)-t.left+Dialog.SPACE_TO_SCREEN_EDGE;e.setStyles(this._controls.innerContainer,{right:n+"px !important",left:"auto !important"}),e.setStyles(this._controls.pointer,{right:o+"px !important",left:"auto !important"})}}_alignToTop(){this._controls.innerContainer.classList.remove("lt-dialog__container-bottom"),this._controls.innerContainer.classList.add("lt-dialog__container-top");const e=this._controls.innerContainer.getBoundingClientRect(),t=new DomMeasurement(document);if(this._controls.innerContainer.classList.add("lt-dialog__container-hide"),e.right>=document.documentElement.clientWidth-Dialog.SPACE_TO_SCREEN_EDGE){const n=parseInt(t.getStyle(this._controls.innerContainer,"left"),10)-(e.right-document.documentElement.clientWidth)-Dialog.SPACE_TO_SCREEN_EDGE,o=parseInt(t.getStyle(this._controls.pointer,"left"),10)+(e.right-document.documentElement.clientWidth)+Dialog.SPACE_TO_SCREEN_EDGE;t.setStyles(this._controls.innerContainer,{left:n+"px !important",right:"auto !important"}),t.setStyles(this._controls.pointer,{left:o+"px !important",right:"auto !important"})}this._controls.innerContainer.classList.remove("lt-dialog__container-hide")}_updateContent(){if(!this._controls.content)return;this._controls.content.innerHTML="",this._controls.content.classList.remove("lt-dialog__has-errors");const e=this._state.requestStatus;e===REQUEST_STATUS.COMPLETED||this._inApplyFixMode&&e===REQUEST_STATUS.IN_PROGRESS?this._renderCompletedState():e===REQUEST_STATUS.IN_PROGRESS?this._renderInProgressState():e===REQUEST_STATUS.DISABLED?this._renderDisabledState():e===REQUEST_STATUS.TEXT_TOO_LONG?this._renderTextTooLongState():e===REQUEST_STATUS.UNSUPPORTED_LANGUAGE?this._renderUnsupportedLanguageState():e===REQUEST_STATUS.DISCONNECTED?this._renderDisconnectedState():e===REQUEST_STATUS.FAILED&&this._renderFailedState(),this._position()}_renderInProgressState(){const e=document.createElement("lt-div");e.className="lt-dialog__big-loader",this._controls.content.appendChild(e)}_renderCompletedState(){this._state.errors&&this._state.errors.length?(this._controls.content.classList.add("lt-dialog__has-errors"),this._state.errors.forEach(e=>{const t=document.createElement("lt-div");if(t.innerHTML=DOMPurify.sanitize(e.description),t.className="lt-dialog__error-item",e.rule.urls&&e.rule.urls.length>0){const n=document.createElement("lt-span");n.classList.add("lt-dialog__more-details"),n.title=browser.i18n.getMessage("moreDetails"),this._eventListeners.push(addUseCaptureEvent(n,"click",n=>{this._onMoreDetailsClick(e.rule.urls[0],n),t.remove()})),t.appendChild(n)}let n=null;t.addEventListener("mouseenter",()=>{n=setTimeout(()=>this._onErrorSelected(e.id),800)}),t.addEventListener("mouseleave",()=>{clearTimeout(n),this._onErrorSelected(null)});const o=Math.min(e.fixes.length,config.MAX_FIXES_COUNT);for(let n=0;n<o;n++){const o=document.createElement("lt-div");o.className="lt-dialog__fix-container";const s=document.createElement("lt-div");s.className="lt-dialog__original-phrase",s.textContent=e.originalPhrase,o.appendChild(s);const i=document.createElement("lt-div");i.className="lt-dialog__arrow",o.appendChild(i);const r=document.createElement("lt-div");r.textContent=e.fixes[n].value,r.title=e.fixes[n].shortDescription||"",r.className="lt-dialog__fix",this._eventListeners.push(addUseCaptureEvent(r,"click",o=>{this._onFixClick(e,n,o),t.remove()})),o.appendChild(r),t.appendChild(o),e.fixes[n].value.length>=14&&t.classList.add("lt-dialog__long-fix")}if(0===o){const n=document.createElement("lt-div");n.className="lt-dialog__fix-container";const o=document.createElement("lt-div");o.className="lt-dialog__original-phrase",o.textContent=e.originalPhrase,n.appendChild(o),t.appendChild(n)}let s=document.createElement("lt-div");e.isSpellingError?(s.classList.add("lt-dialog__add-to-dictionary"),s.textContent=browser.i18n.getMessage("addToDictionaryTitle",e.misspelledWord),this._eventListeners.push(addUseCaptureEvent(s,"click",n=>{this._onAddToDictionaryClick(e,n),t.remove()}))):(s.classList.add("lt-dialog__turn-off-rule"),s.textContent=browser.i18n.getMessage("turnOffRule"),this._eventListeners.push(addUseCaptureEvent(s,"click",n=>{this._onTurnOffRuleClick(e,n),t.remove()}))),t.appendChild(s),this._controls.content.appendChild(t)}),this._renderIgnoredErrorsStats(),this._renderPremiumErrorsTeaser()):this._state.hiddenErrors&&this._state.hiddenErrors.length?this._renderPremiumState():(this._renderNoErrorsState(),this._renderIgnoredErrorsStats(),this._renderPremiumErrorsTeaser()),this._controls.incompleteResult.classList.toggle("lt-dialog__incomplete-result-show",!!this._state.isIncompleteResult)}_renderNoErrorsState(){const e=document.createElement("lt-div");e.className="lt-dialog__no-errors",e.innerHTML=Dialog.MESSAGES.NO_ERRORS,this._controls.content.appendChild(e),this._renderRatingTeaser()}_renderIgnoredErrorsStats(){if(this._state.ignoredErrorsStats&&(0!==this._state.ignoredErrorsStats.byDictionary||0!==this._state.ignoredErrorsStats.byRules)){let e=[];if(this._state.ignoredErrorsStats.byDictionary>0){const t=1===this._state.ignoredErrorsStats.byDictionary?"errorsIgnoredByDictionarySingular":"errorsIgnoredByDictionary",n=browser.i18n.getMessage(t,[this._state.ignoredErrorsStats.byDictionary]);e.push(n)}if(this._state.ignoredErrorsStats.byRules>0){const t=1===this._state.ignoredErrorsStats.byRules?"errorsIgnoredByRulesSingular":"errorsIgnoredByRules",n=browser.i18n.getMessage(t,[this._state.ignoredErrorsStats.byRules]);e.push(n)}const t=document.createElement("lt-div");this._state.errors&&this._state.errors.length?t.className="lt-dialog__ignored-errors-item":t.className="lt-dialog__ignored-errors-message",t.textContent=e.join(", "),this._eventListeners.push(addUseCaptureEvent(t,"click",this._onSettingsClick.bind(this))),this._controls.content.appendChild(t)}}_renderRatingTeaser(){if(!this._state.hiddenErrors.length&&!this._controls.teaserElement&&!this._uiState.hasRated&&isRuntimeConnected()&&0===Math.floor(3*Math.random())){let e=browser.runtime.getURL("/content/iframes/rating/rating.html");e+=`?componentName=dialog&hostName=${encodeURIComponent(getCurrentHostname())}`,this._controls.teaserElement=document.createElement("iframe"),this._controls.teaserElement.src=e,this._controls.teaserElement.className="lt-dialog-iframe lt-dialog-rating-iframe",this._controls.content.after(this._controls.teaserElement)}}_renderPremiumErrorsTeaser(){if(this._state.hiddenErrors.length&&!this._controls.teaserElement&&isRuntimeConnected()){let e=browser.runtime.getURL("/content/iframes/premiumErrors/premiumErrors.html");const t=this._state.hiddenErrors.filter(e=>!e.isSuggestionError).length,n=this._state.hiddenErrors.filter(e=>e.isSuggestionError).length;e+=`?grammarMatches=${t}`,e+=`&styleMatches=${n}`,this._controls.teaserElement=document.createElement("iframe"),this._controls.teaserElement.src=e,this._controls.teaserElement.className="lt-dialog-iframe lt-dialog-premium-errors-iframe",this._controls.content.after(this._controls.teaserElement)}}_renderPremiumState(){const e=document.createElement("lt-div");e.className="lt-dialog__premium__headline",e.textContent=1===this._state.hiddenErrors.length?browser.i18n.getMessage("dialogPremiumHeadlineSingular"):browser.i18n.getMessage("dialogPremiumHeadlinePlural",[this._state.hiddenErrors.length]);const t=document.createElement("lt-div");t.className="lt-dialog__premium__text",t.textContent=browser.i18n.getMessage("dialogPremiumText");const n=document.createElement("lt-div");n.className="lt-dialog__premium__button",n.textContent=browser.i18n.getMessage("dialogPremiumButton"),this._eventListeners.push(addUseCaptureEvent(n,"click",e=>{e.stopImmediatePropagation();let t="https://languagetoolplus.com/webextension/upgrade?pk_campaign=addon2-dialog-premium";t+=`&grammarMatches=${this._state.hiddenErrors.filter(e=>!e.isSuggestionError).length}`,t+=`&styleMatches=${this._state.hiddenErrors.filter(e=>e.isSuggestionError).length}`,window.open(t,"_blank"),Tracker.trackEvent("Action","dialog:premium:click")})),this._controls.content.appendChild(e),this._controls.content.appendChild(t),this._controls.content.appendChild(n)}_renderDisabledState(){const e=document.createElement("lt-div");e.className="lt-dialog__enable-text",e.innerHTML=Dialog.MESSAGES.ENABLE;const t=document.createElement("lt-div");t.className="lt-dialog__enable-everywhere",t.innerHTML=Dialog.MESSAGES.ENABLE_EVERYWHERE_BUTTON,this._eventListeners.push(addUseCaptureEvent(t,"click",this._enableEverywhere.bind(this)));const n=document.createElement("lt-div");n.className="lt-dialog__enable-here",n.innerHTML=Dialog.MESSAGES.ENABLE_HERE_BUTTON,this._eventListeners.push(addUseCaptureEvent(n,"click",this._enableHere.bind(this))),this._controls.content.appendChild(e),this._controls.content.appendChild(t),this._controls.content.appendChild(n)}_renderTextTooLongState(){const e=document.createElement("lt-div");e.className="lt-dialog__premium__headline",e.textContent=Dialog.MESSAGES.TEXT_TOO_LONG_HEADLINE;const t=document.createElement("lt-div");t.className="lt-dialog__premium__text",t.textContent=Dialog.MESSAGES.TEXT_TOO_LONG_TEXT;const n=document.createElement("lt-div");n.className="lt-dialog__premium__button",n.textContent=Dialog.MESSAGES.TEXT_TOO_LONG_BUTTON,this._eventListeners.push(addUseCaptureEvent(n,"click",e=>{e.stopImmediatePropagation(),window.open("https://languagetoolplus.com/webextension/upgrade?pk_campaign=addon2-dialog-text-too-long","_blank"),Tracker.trackEvent("Action","dialog:text_too_long:click")})),this._controls.content.appendChild(e),this._controls.content.appendChild(t),this._controls.content.appendChild(n)}_renderUnsupportedLanguageState(){const e=document.createElement("lt-div");e.innerHTML=browser.i18n.getMessage("statusIconUnsupportedLanguage",DOMPurify.sanitize(this._state.languageName)),e.className="lt-dialog__exception-message",this._controls.content.appendChild(e)}_renderDisconnectedState(){this._controls.header.remove(),this._controls.sendFeedback.remove();const e=document.createElement("lt-div");e.innerHTML=Dialog.MESSAGES.EXTENSION_UPDATED_HEADLINE,e.className="lt-dialog__exception-headline",this._controls.content.appendChild(e);const t=document.createElement("lt-div");t.innerHTML=Dialog.MESSAGES.EXTENSION_UPDATED_TEXT,t.className="lt-dialog__exception-message",this._controls.content.appendChild(t)}_renderFailedState(){const e=document.createElement("lt-div");e.innerHTML=DOMPurify.sanitize(this._state.exceptionMessage)||browser.i18n.getMessage("statusIconError"),e.className="lt-dialog__exception-message",this._controls.content.appendChild(e)}_onKeydown(e){"Escape"===e.key&&(this.destroy(),e.stopImmediatePropagation())}_onLanguageChange(e){e.stopImmediatePropagation();const t=LANGUAGES.find(e=>e.code===this._controls.languageSelector.value);if(!t)throw new Error("Selected language not found in LANGUAGES array");const n={dialog:this,language:t};dispatchCustomEvent(Dialog.eventNames.changeLanguage,n),this.setCurrentLanguage(t.code)}_onTurnOffClick(){dispatchCustomEvent(Dialog.eventNames.turnOff)}_onSettingsClick(e){e.stopImmediatePropagation(),dispatchCustomEvent(Dialog.eventNames.openSettings)}_gotoLanguageTool(e){e.stopImmediatePropagation(),window.open("https://languagetoolplus.com/?pk_campaign=addon2-dialog","_blank")}_showFeedbackForm(e){e.stopImmediatePropagation();const t={dialog:this};dispatchCustomEvent(Dialog.eventNames.showFeedbackForm,t)}_onErrorSelected(e){const t={dialog:this,errorId:e};dispatchCustomEvent(Dialog.eventNames.errorSelected,t)}_onMoreDetailsClick(e,t){t.stopImmediatePropagation();const n={url:e.value};dispatchCustomEvent(Dialog.eventNames.moreDetailsClicked,n)}_onFixClick(e,t,n){n.stopImmediatePropagation(),this._inApplyFixMode=!0;const o={dialog:this,error:e,fixIndex:t};dispatchCustomEvent(Dialog.eventNames.fixSelected,o)}_onAddToDictionaryClick(e,t){t.stopImmediatePropagation(),this._inApplyFixMode=!0;const n={dialog:this,error:e};dispatchCustomEvent(Dialog.eventNames.addToDictionaryClicked,n)}_onTurnOffRuleClick(e,t){t.stopImmediatePropagation(),this._inApplyFixMode=!0;const n={dialog:this,error:e};dispatchCustomEvent(Dialog.eventNames.turnOffRuleClicked,n)}_enableEverywhere(e){e.stopImmediatePropagation();const t={dialog:this};dispatchCustomEvent(Dialog.eventNames.enableEverywhere,t)}_enableHere(e){e.stopImmediatePropagation();const t={dialog:this};dispatchCustomEvent(Dialog.eventNames.enableHere,t)}updateState(e){isSameObject(this._state,e)||(this._state=Object.assign(this._state||{},e),this._updateContent())}setCurrentLanguage(e){if(!isRuntimeConnected())return;e=e.toLowerCase();const t=LANGUAGES.find(t=>t.code===e)||LANGUAGES.find(t=>e.startsWith(t.code))||LANGUAGES.find(e=>"en-us"===e.code),n=browser.runtime.getURL("/assets/images/flags/"+t.code+".svg");this._controls.currentLanguage.textContent=t.name,new DomMeasurement(document).setStyles(this._controls.currentLanguage,{"background-image":`url('${n}') !important`}),this._controls.languageSelector.value=t.code}destroy(){fadeOutAndRemove(this._controls.container,()=>{this._toolbarContainer.classList.remove("lt-toolbar--dialog-opened")}),this._controls={},this._eventListeners.forEach(e=>{e.destroy()}),this._eventListeners=[];const e={dialog:this};dispatchCustomEvent(Dialog.eventNames.destroyed,e)}}Dialog.CONTAINER_ELEMENT_NAME="lt-dialog",Dialog.SPACE_TO_SCREEN_EDGE=5,Dialog.MESSAGES={EXTENSION_UPDATED_HEADLINE:browser.i18n.getMessage("extensionUpdatedHeadline"),EXTENSION_UPDATED_TEXT:browser.i18n.getMessage("extensionUpdatedText",["<lt-span class='lt-dialog__icon'></lt-span>"]),INCOMPLETE_RESULT:browser.i18n.getMessage("incompleteResult"),POWERED_BY:browser.i18n.getMessage("poweredBy"),FEEDBACK:browser.i18n.getMessage("reportAnIssue"),ENABLE:browser.i18n.getMessage("enableInDialog"),ENABLE_EVERYWHERE_BUTTON:browser.i18n.getMessage("enableEverywhereButton"),ENABLE_HERE_BUTTON:browser.i18n.getMessage("enableHereButton"),SETTINGS_TITLE:browser.i18n.getMessage("settingsHeadline"),NO_ERRORS:browser.i18n.getMessage("noErrorsFound2"),TEXT_TOO_LONG_HEADLINE:browser.i18n.getMessage("dialogTextTooLongHeadline"),TEXT_TOO_LONG_TEXT:browser.i18n.getMessage("dialogTextTooLongText"),TEXT_TOO_LONG_BUTTON:browser.i18n.getMessage("dialogTextTooLongButton")},Dialog.eventNames={changeLanguage:"lt-dialog.changeLanguage",enableHere:"lt-dialog.enableHere",enableEverywhere:"lt-dialog.enableEverywhere",errorSelected:"lt-dialog.errorSelected",fixSelected:"lt-dialog.fixSelected",turnOff:"lt-dialog.turnOff",openSettings:"lt-dialog.openSettings",addToDictionaryClicked:"lt-dialog.addToDictionaryClicked",moreDetailsClicked:"lt-dialog.moreDetailsClicked",turnOffRuleClicked:"lt-dialog.turnOffRuleClicked",destroyed:"lt-dialog.destroyed",showFeedbackForm:"lt-dialog.showFeedbackForm"};