/*! (C) Copyright 2018 LanguageTooler GmbH. All rights reserved. */
class Highlighter{constructor(e,t,i,s=!1){this._ceElement=e,this._inputArea=t,this._inputAreaWrapper=i,this._isMirror=s,this._highlightedText="",this._highlightedBlocks=[],this._domMeasurement=new DomMeasurement(t.ownerDocument),this._onInputScroll=bindAndCatch(this._onInputScroll,this),this._onElementClick=bindAndCatch(this._onElementClick,this),this._onContentChanged=bindAndCatch(this._onContentChanged,this),this._render=bindAndCatch(this._render,this),this._inputArea.addEventListener("scroll",this._onInputScroll),this._ceElement.addEventListener("click",this._onElementClick),this._ceElement.addEventListener(Mirror.eventNames.click,this._onElementClick),this._isDraftJsIssue=Boolean(this._ceElement.firstElementChild&&this._ceElement.firstElementChild.hasAttribute("data-contents")),this._contentChangedObserver=new MutationObserver(this._onContentChanged);const n={attributes:!1,attributeOldValue:!1,characterData:!0,characterDataOldValue:!1,childList:!0,subtree:!0};s||(n.attributes=!0,n.attributeFilter=["style","class"]),this._contentChangedObserver.observe(this._ceElement,n),window.ResizeObserver&&(this._resizeObserver=new window.ResizeObserver(this._render),this._resizeObserver.observe(this._ceElement)),this._renderInterval=setAnimationFrameInterval(this._render,config.RENDER_INTERVAL),this._render()}_toPageCoordinates(e,t){const i=this._domMeasurement.getPaddingBox(t),s=this._getCEElementScroll(),n=e.top+i.top-s.top,r=e.left+i.left-s.left;return{top:n,left:r,bottom:n+e.height,right:r+e.width,width:e.width,height:e.height}}_toElementCoordinates(e,t){const i=this._domMeasurement.getPaddingBox(t,!1),s=this._getCEElementScroll();return{x:e.x-i.left+s.left,y:e.y-i.top+s.top}}_getCEElementScroll(e=!0){return this._isMirror?{top:+this._ceElement.dataset.ltScrollTop,left:+this._ceElement.dataset.ltScrollLeft}:(e&&this._domMeasurement.clearCache(),this._domMeasurement.getScrollPosition(this._ceElement))}_render(){if(!this._ceElement.parentNode||!this._inputArea.parentNode)return;const e=this._inputArea.ownerDocument;this._container||(this._container=e.createElement(Highlighter.CONTAINER_ELEMENT_NAME),this._container.setAttribute("contenteditable","false"),this._wrapper=e.createElement("lt-div"),this._wrapper.setAttribute("spellcheck","false"),this._wrapper.className="lt-highlighter__wrapper",this._canvas=e.createElement("canvas"),this._canvas.className="lt-highlighter__canvas",this._wrapper.appendChild(this._canvas),this._container.appendChild(this._wrapper)),this._domMeasurement.clearCache();const t=this._domMeasurement.getPaddingBox(this._ceElement),i={};if(this._inputArea===e.body&&e.scrollingElement===e.documentElement&&"BackCompat"!==e.compatMode){const e=this._domMeasurement.getStyles(this._inputArea,["overflow-x","overflow-y"]);i["overflow-x"]="hidden"===e["overflow-x"]?"hidden":"visible",i["overflow-y"]="hidden"===e["overflow-y"]?"hidden":"visible"}const s=this._domMeasurement.getScaleFactor(this._ceElement),n=t.width*s,r=t.height*s,h=this._width,o=this._height;i.width=n+"px",i.height=r+"px",this._domMeasurement.setStyles(this._wrapper,i,!0);let a=this._domMeasurement.getStyle(this._inputArea,"z-index");(a=parseInt(a)||0)>0||this._domMeasurement.isStackingContext(this._inputArea)?this._domMeasurement.setStyles(this._container,{"z-index":`${a+1}`}):this._domMeasurement.setStyles(this._container,{"z-index":"auto"}),this._updateScrolling(),this._isDraftJsIssue&&this._ceElement.parentNode.parentNode?this._ceElement.parentNode.previousSibling!==this._container&&this._ceElement.parentNode.parentNode.insertBefore(this._container,this._ceElement.parentNode):this._ceElement.previousElementSibling!==this._container&&this._ceElement.parentNode.insertBefore(this._container,this._ceElement);const l=this._domMeasurement.getPaddingBox(this._wrapper),c=t.top-l.top;if(Math.abs(c)>.05){let e=parseFloat(this._domMeasurement.getStyle(this._wrapper,"top"));e+=c,this._domMeasurement.setStyles(this._wrapper,{top:e+"px"},!0)}const _=t.left-l.left;if(Math.abs(_)>.05){let e=parseFloat(this._domMeasurement.getStyle(this._wrapper,"left"));e+=_,this._domMeasurement.setStyles(this._wrapper,{left:e+"px"},!0)}const d=this._domMeasurement.getScrollDimensions(this._inputArea);n===h&&r===o&&this._canvas.width===d.width&&this._canvas.height===d.height||(this._width=n,this._height=r,this._redraw(!1))}_redraw(e=!0){e&&this._domMeasurement.clearCache(),this._highlightedText=this._inputAreaWrapper.getText();const t=this._domMeasurement.getScrollDimensions(this._inputArea),i=t.width,s=t.height;if(this._canvas.width=i,this._canvas.height=s,!this._highlightedBlocks.length)return;const n=this._canvas.getContext("2d");n.lineWidth=2;const r=this._getCEElementScroll(!1),h=this._domMeasurement.getScaleFactor(this._ceElement);for(const e of this._highlightedBlocks){const t=this._inputAreaWrapper.getTextRanges(e.offset,e.length),o=this._domMeasurement.getTextBoundingBoxes(t,this._ceElement,r);if(e.isEmphasized){"#F91A47"===e.emphasiseColor?n.fillStyle=e.emphasiseColor+"33":n.fillStyle=e.emphasiseColor+"59";for(const e of o){const t=Math.max(0,(e.left-1)*h),r=Math.min(i,(e.right+1)*h),o=Math.max(0,e.top*h),a=Math.min(s,e.bottom*h);n.fillRect(t,o,r-t,a-o)}}if(e.isUnderlined){n.strokeStyle=e.underlineColor;for(const e of o){const t=Math.max(0,(e.left-1)*h),r=Math.min(i,(e.right+1)*h),o=Math.min(s-1,e.bottom*h);n.beginPath(),n.moveTo(t,o),n.lineTo(r,o),n.stroke()}}e.textBoxes=o}}_updateScrolling(){const e=this._getCEElementScroll();this._domMeasurement.setStyles(this._canvas,{"margin-top":-e.top+"px","margin-left":-e.left+"px"},!0)}_onInputScroll(){this._container&&window.requestAnimationFrame(()=>{this._updateScrolling()})}_onElementClick(e){if(this._isMirror&&e.stopImmediatePropagation(),!this._container)return;this._domMeasurement.clearCache();let t={x:e.clientX,y:e.clientY};t=this._toElementCoordinates(t,this._ceElement);for(const e of this._highlightedBlocks){const i=e.textBoxes.find(e=>isPointInsideBox(e,t));if(i){const t={highlighter:this,blockId:e.id,clickedRectangle:this._toPageCoordinates(i,this._ceElement)};return void dispatchCustomEvent(Highlighter.eventNames.blockClicked,t)}}}_onContentChanged(e){if(!this._container)return;const t=this._inputAreaWrapper.getText(),i=e.some(e=>{if("attributes"===e.type)return!0;if(this._isMirror)return!1;return!!Array.from(e.addedNodes||[]).some(e=>e.nodeType===document.ELEMENT_NODE)||!!Array.from(e.removedNodes||[]).some(e=>e.nodeType===document.ELEMENT_NODE)});(this._highlightedText!==t||i)&&this._redraw()}highlight(e=[]){this._highlightedBlocks=e,this._redraw()}destroy(){this._inputArea.removeEventListener("scroll",this._onInputScroll),this._ceElement.removeEventListener("click",this._onElementClick),this._ceElement.removeEventListener(Mirror.eventNames.click,this._onElementClick),this._contentChangedObserver.disconnect(),this._renderInterval&&this._renderInterval.destroy(),this._container&&this._container.remove(),this._resizeObserver&&this._resizeObserver.disconnect(),this._domMeasurement.clearCache()}}Highlighter.CONTAINER_ELEMENT_NAME="lt-highlighter",Highlighter.eventNames={blockClicked:"lt-highlighter.blockClicked"};