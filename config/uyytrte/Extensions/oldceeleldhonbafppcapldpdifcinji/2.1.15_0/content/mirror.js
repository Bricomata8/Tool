/*! (C) Copyright 2018 LanguageTooler GmbH. All rights reserved. */
class Mirror{constructor(e){this._textArea=e,this._domMeasurement=new DomMeasurement(this._textArea.ownerDocument),this._render=bindAndCatch(this._render,this),this._updateText=bindAndCatch(this._updateText,this),this._onTextAreaScroll=bindAndCatch(this._onTextAreaScroll,this),this._onTextAreaClick=bindAndCatch(this._onTextAreaClick,this),this._render(),this._textArea.addEventListener("scroll",this._onTextAreaScroll),this._textArea.addEventListener("click",this._onTextAreaClick),this._textArea.addEventListener("input",this._updateText),window.ResizeObserver&&(this._resizeObserver=new window.ResizeObserver(this._render),this._resizeObserver.observe(this._textArea)),this._renderInterval=setAnimationFrameInterval(this._render,config.RENDER_INTERVAL)}static getElementByPos(e,t,r){const i=new DOMWalker(e);let s=null;do{const e=i.node();if(isElementNode(e)){getBorderBoxes(e).some(e=>isPointInsideBox(e,t,r))&&(s=e)}}while(i.next());return s}_dispatchClick(e,t){const r=new MouseEvent(Mirror.eventNames.click,{view:window,screenX:t.screenX,screenY:t.screenY,clientX:t.clientX,clientY:t.clientY,button:t.button,buttons:t.buttons,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey,bubbles:!0,cancelable:!0});e.dispatchEvent(r)}_dispatchInput(){const e=new Event(Mirror.eventNames.input,{bubbles:!0,cancelable:!0});this.getCloneElement().dispatchEvent(e)}_render(){if(!this._textArea.parentElement)return;this._container||(this._container=document.createElement(Mirror.CONTAINER_ELEMENT_NAME),this._wrapper=document.createElement("lt-div"),this._wrapper.setAttribute("spellcheck","false"),this._wrapper.className="lt-mirror__wrapper",this._canvas=document.createElement("lt-div"),this._canvas.className="lt-mirror__canvas",this._wrapper.appendChild(this._canvas),this._container.appendChild(this._wrapper)),this._domMeasurement.clearCache();this._domMeasurement.copyStyles(this._textArea,this._wrapper,["border","border-radius","border-top-width","border-right-width","border-left-width","border-bottom-width","border-top-style","border-right-style","border-left-style","border-bottom-style","font","font-family","font-feature-settings","font-kerning","font-language-override","font-size","font-size-adjust","font-stretch","font-style","font-synthesis","font-variant","font-variant-caps","font-variant-east-asian","font-variant-ligatures","font-variant-numeric","font-weight","hyphens","letter-spacing","line-break","line-height","margin","margin-top","margin-left","margin-bottom","margin-right","padding","padding-top","padding-left","padding-right","padding-bottom","text-align","text-decoration","text-indent","text-transform","word-spacing","word-wrap"],!0);const e=this._domMeasurement.getStyle(this._textArea,"line-height");"normal"!==e&&"inherit"!==e&&this._domMeasurement.setStyles(this._textArea,{"line-height":e}),this._updateText(),this._textArea.previousElementSibling!==this._container&&this._textArea.parentElement.insertBefore(this._container,this._textArea);const t=this._domMeasurement.getContentBox(this._textArea);this._domMeasurement.setStyles(this._wrapper,{width:t.width+"px",height:t.height+"px"},!0);const r=this._domMeasurement.getBorderBox(this._wrapper,!1),i=this._domMeasurement.getBorderBox(this._textArea,!1),s=i.left-r.left;if(Math.abs(s)>.05){let e=parseFloat(this._domMeasurement.getStyle(this._wrapper,"margin-left"));e+=s,this._domMeasurement.setStyles(this._wrapper,{"margin-left":e+"px"},!0)}const n=i.top-r.top;if(Math.abs(n)>.05){let e=parseFloat(this._domMeasurement.getStyle(this._wrapper,"margin-top"));e+=n,this._domMeasurement.setStyles(this._wrapper,{"margin-top":e+"px"},!0)}const a=this._domMeasurement.getScrollDimensions(this._textArea);let o=a.width-t.padding.left-t.padding.right,h=a.height-t.padding.top-t.padding.bottom;o===Math.round(t.width)&&(o=t.width),this._domMeasurement.setStyles(this._canvas,{width:o+"px",height:h+"px"},!0),this._updateScrolling(!1)}_updateScrolling(e=!0){e&&this._domMeasurement.clearCache();const t=this._domMeasurement.getScrollPosition(this._textArea);this._domMeasurement.setStyles(this._canvas,{"margin-top":-t.top+"px","margin-left":-t.left+"px"},!0),this._wrapper.dataset.ltScrollTop=t.top.toString(),this._wrapper.dataset.ltScrollLeft=t.left.toString()}_updateText(){const e=this._textArea.value;this._currentText!==e&&(this._currentText=e,this._canvas.textContent=e,this._updateScrolling(),this._dispatchInput())}_onTextAreaScroll(){window.requestAnimationFrame(()=>{this._updateScrolling()})}_onTextAreaClick(e){const t=Mirror.getElementByPos(this.getCloneElement(),e.clientX,e.clientY);t&&this._dispatchClick(t,e)}getCloneElement(){return this._wrapper}enableRangeMeasurements(){this._wrapper.classList.add("lt-mirror-enable-range-measurement")}disableRangeMeasurements(){this._wrapper.classList.remove("lt-mirror-enable-range-measurement")}destroy(){this._textArea.removeEventListener("input",this._updateText),this._textArea.removeEventListener("scroll",this._onTextAreaScroll),this._textArea.removeEventListener("click",this._onTextAreaClick),this._renderInterval&&this._renderInterval.destroy(),this._container&&this._container.remove(),this._resizeObserver&&this._resizeObserver.disconnect(),this._domMeasurement.clearCache()}}Mirror.CONTAINER_ELEMENT_NAME="lt-mirror",Mirror.eventNames={input:"lt-mirror-input",click:"lt-mirror-click"};